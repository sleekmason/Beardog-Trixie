#!/bin/bash
# Made for Lilidog by sleekmason 31 Oct 2025

# Check for root
if [ "$(id -u)" -ne 0 ]; then
    printf "ERROR: This script must be run as root.\n" >&2
    exit 1
fi

# Variables
TEXTDOMAIN="kernel-remover"
export TEXTDOMAIN
TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAINDIR

TITLE="Kernel Remover"
COOLICON="applications-engineering"
CURRENTKERNEL=$(uname -r)
CURRENT=" Cannot remove the active kernel  -  '${CURRENTKERNEL}'"

force=0
frontend="yad"
xtra=0

usage() {
    echo "$(basename "$0")"
    echo "     -G parameter    choose frontend (text | yad)"
    echo "     -f              force cleanup without confirmation"
    echo "     -h              show this usage"
    exit 1
}

while getopts fhxG: name; do
    case $name in
        f) force=1 ;;
        G) frontend="$OPTARG" ;;
        h) usage ;;
        x) xtra=1 ;;
        *) usage ;;
    esac
done
shift $((OPTIND - 1))

# Determine frontend (text or yad)
if [ -z "$frontend" ]; then
    if [ -n "$DISPLAY" ] && command -v yad >/dev/null 2>&1; then
        frontend="yad"
    else
        frontend="text"
    fi
fi

if [ -n "$SUDO_USER" ]; then
    REAL_USER="$SUDO_USER"
else
    REAL_USER="$(logname 2>/dev/null || id -un)"
fi

USER_HOME="$(getent passwd "$REAL_USER" | cut -d: -f6)"

LOGDIR="$USER_HOME/.local/share"
mkdir -p "$LOGDIR" || { echo "Failed to create log directory $LOGDIR"; exit 1; }
LOGFILE="$LOGDIR/kernel-remover.log"
touch "$LOGFILE" || { echo "Failed to create log file $LOGFILE"; exit 1; }
chown "$REAL_USER:$REAL_USER" "$LOGDIR" "$LOGFILE"

echo -e "\n===== Kernel Remover run on $(date '+%Y-%m-%d %H:%M:%S') =====\n" >> "$LOGFILE"

exec > >(tee -a "$LOGFILE") 2>&1

# Progress bar
start_wait_dialog() {
    yad --progress \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --center --width=420 --borders=10 \
        --pulsate \
        --no-buttons \
        --auto-close \
        --text="<span foreground='white'><b>Please wait…</b></span>" &
    YAD_WAIT_PID=$!
}

stop_wait_dialog() {
    kill "$YAD_WAIT_PID" 2>/dev/null
}

get_KernelList() {
    KernelList=""
    for v in /boot/vmlinuz-*; do
        Kernel=$(basename "$v" | sed 's/vmlinuz-//')
        if [ "$Kernel" != "$CURRENTKERNEL" ]; then
            KernelList="${KernelList} ${Kernel}"
        fi
    done
}

remove_kernel() {
    Kernel=$1
    if [ "$Kernel" != "$CURRENTKERNEL" ]; then
        echo "Removing kernel: $Kernel"
        apt-get remove --purge --yes $(dpkg -l | grep "$Kernel" | awk '{print $2}') 2>/dev/null
        dpkg -l "linux-headers-${Kernel}-common" >/dev/null 2>&1 && \
            apt-get remove --purge --yes "linux-headers-${Kernel}-common"
        dpkg -l "linux-support-${Kernel}" >/dev/null 2>&1 && \
            apt-get remove --purge --yes "linux-support-${Kernel}"
        [ ! -e "/boot/vmlinuz-${Kernel}" ] && rm -rf /lib/modules/"${Kernel}"
    fi
}

# Main
if [ "$xtra" -eq 1 ]; then
    KernelList="$@"
    for i in ${KernelList}; do
        echo "Removing kernel $i"
        remove_kernel "$i"
    done
    echo "Removed: ${KernelList}"
    exit 0
fi

get_KernelList

if [ -z "$KernelList" ]; then
    MSG="There is only one kernel installed on this system. Nothing to be done!"
    if [ "$frontend" = "text" ]; then
        echo "$MSG"
    else
        yad --center --borders=10 --width=400 --title="$TITLE" \
            --window-icon="$COOLICON" \
            --text="<span foreground='white'>${MSG}</span>" \
            --button=gtk-ok:0
    fi
    exit 0
fi

if [ "$force" -eq 1 ]; then
    echo "$CURRENT"
    for i in ${KernelList}; do
        echo "Removing kernel $i"
        remove_kernel "$i"
    done
    echo "Removed: ${KernelList}"
    exit 0
fi

# User selection (YAD or TEXT)
if [ "$frontend" = "text" ]; then
    echo "$CURRENT"
    echo "Available kernels to remove:"
    echo "$KernelList"
    echo
    read -rp "Enter kernel(s) to remove (space-separated): " CHOICE
else
    yad_list=()
    for k in ${KernelList}; do
        yad_list+=(FALSE "$k")
    done

    CHOICE=$(yad --list --checklist \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --width=460 --height=222 \
        --center --borders=10 \
        --column="Select" --column="Kernel(s)" \
        --text="<span foreground='white'>${CURRENT}</span>" \
        --separator=" " \
        "${yad_list[@]}" \
        2>/dev/null)

    CHOICE=$(echo "$CHOICE" | sed 's/\bTRUE\b//g')
fi

[ -z "$CHOICE" ] && exit 0

# Confirmation dialog
if [ "$frontend" = "text" ]; then
    echo
    echo "The following kernel(s) have been selected for removal: ${CHOICE}"
    echo "A log will be saved to $LOGFILE"
    echo
    read -rp "Would you like to continue? [y/N]: " CONFIRM </dev/tty
    case "$CONFIRM" in
        [yY][eE][sS]|[yY]) ;;
        *) echo "Operation canceled."; exit 0 ;;
    esac
else
    BULLETS=""
    for k in ${CHOICE}; do
        BULLETS="${BULLETS}• ${k}\n"
    done

    yad --question \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --width=460 --center --borders=10 \
        --text="<span foreground='white'>The following kernel(s) have been selected for removal:\n<b>${BULLETS}</b>\n\nA log will be saved to ~/.local/share/kernel-remover.log\n\nWould you like to continue?</span>" \
        --button=gtk-yes:0 --button=gtk-no:1
    [ $? -ne 0 ] && exit 0
fi

# Removal
[ "$frontend" = "yad" ] && start_wait_dialog

for i in ${CHOICE}; do
    echo "Confirmed removal for $i"
    remove_kernel "$i"
done

[ "$frontend" = "yad" ] && stop_wait_dialog

if [ "$frontend" = "yad" ]; then
    yad --info \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --width=460 --center --borders=10 \
        --text="<span foreground='white'>Removed kernel(s):<b> ${CHOICE}</b></span>"
else
    echo "Removed kernel(s): ${CHOICE}"
    echo "Log saved to $LOGFILE"
fi

exit 0
