#!/bin/bash
echo ""
read -p "   [0;33mSnap Installer[0m

   This will install Snapd and the Snap App Store, the app store 
   for Linux.
   
   Please note that the installation can take a while for a slow
   connection as snap searches for resources. About 7 minutes on
   a fairly decent connection here.

   [0;34mhttps://snapcraft.io//[0m
   
   [0;32m-------------------------------------------------------------
   
   Please press enter to install Snap.
   
   -------------------------------------------------------------[0m
   
   
   Or, close this terminal window to quit the install." ;

if [ -e /run/live/medium ] || [ -e /lib/live/mount ] || \
   findmnt -n -o FSTYPE / | grep -Eq 'overlay|squashfs'; then
    echo ""
    echo "  [0;33m--------------------------------------------------------------[0m"
    echo ""
    echo "  [0;31mLive environment detected.[0m"
    echo ""
    echo "  Snap cannot be installed reliably in a live session."
    echo "  Please install the system to use Snap."
    echo ""
    echo "  [0;33m--------------------------------------------------------------[0m"
    echo ""
    read -n1 -p " Press any key to quit this dialog ... "
    exit 0
fi

sudo apt-get update
sudo apt-get install -y snapd
echo ""
echo "  [0;32mEnabling snapd service...[0m"
echo ""
sudo systemctl enable --now snapd.socket
sudo systemctl enable --now snapd.service

sudo systemctl restart snapd

echo -n "  Waiting for snapd to become ready..."
echo ""
for i in {1..60}; do
    if snap version >/dev/null 2>&1; then
        echo " done!"
        break
    fi
    sleep 2
done

if ! snap version >/dev/null 2>&1; then
    echo ""
    echo "  [0;31mSnapd failed to start after waiting.[0m"
    read -n1 -p " Press any key to quit this dialog... "
    exit 1
fi
echo ""
echo "  [0;32mInstalling the Snap Store... This can take a while.[0m"
echo ""
if ! sudo snap install snap-store; then
    echo "  [0;31mSnap failed â€” temporarily disabling IPv6 for snapd...[0m"

    sudo systemctl set-property snapd.service \
        Environment=SNAPD_DISABLE_IPV6=1 --runtime

    sudo systemctl restart snapd

    echo "  [0;33mRetrying Snap Store install...[0m"
    if ! sudo snap install snap-store; then
        echo ""
        echo "  [0;31mSnap installation failed even after workaround.[0m"
        echo "  [0;31mPlease check network/DNS and try again.[0m"
        read -n1 -p " Press any key to quit this dialog ... "
        exit 1
    fi
fi

sed -i '/Snap Store,         \/snap\/bin\/snap-store,              preferences-other/d' ~/.config/jgmenu/prepend.csv &&
sed -i '/Root Folders,^checkout(rootfiles),folder/a Snap Store,         /snap/bin/snap-store,              preferences-other' ~/.config/jgmenu/prepend.csv
killall -q jgmenu

echo ""
echo "[0;32m-----------------------------------------------------------[0m"
echo ""
echo "[0;32mAll finished![0m"
echo ""
echo "[0;33mYou should find a 'Snap Store' entry in the Quickgrab Menu. [0m" 
echo "" 
echo "[0;33mNote that logging out and back in may be necessary for use.[0m"
echo "" 
echo "[0;31mMenu entries need to be removed manually if uninstalled." 
echo "See Jgmenu under Configuration in the menu for directions.[0m"
echo ""
echo "[0;32m-----------------------------------------------------------[0m"
echo ""

read -n1 -p " Press any key to quit this dialog ... "
